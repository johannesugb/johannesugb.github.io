---
title: "Setting Up a Proper Projection Matrix for Vulkan"
# last_modified_at: 2021-06-18T12:30:00+02:00
categories:
  - GPU-Programming
tags:
  - Vulkan
# header:
#   image: /assets/images/1500x500.jpg
---

In a previous post I have pointed out why projection matrices which are typically used with OpenGL do not work with Vulkan without modifications and can lead to a lot confusion.
In this post, I'd like to describe a strategy how a proper and (hopefully) easy to understand perspective projection matrix for Vulkan can be set-up manually. _Figure 1_ gives an overview of some commonly used spaces and spaces which must follow certain rules that are dictated by the graphics API---i.e. Vulkan for the scope of this blog post.

{: .center}
[![Graphics pipeline, different spaces and operations](/assets/images/different-spaces-some-user-defined.png)](/assets/images/different-spaces-some-user-defined.png)

_Figure 1:_ The spaces displayed with yellow borders and fonts (world space and view space) can be chosen freely by programmers. But for the other spaces, Vulkan dictates certain requirements s.t. its fixed-function steps backface culling, polygon clipping, and homogeneous division (marked with circular symbols) lead to the expected result. All of the spaces are required to be in a right-handed coordinate system. I.e., Vulkan's fixed-function steps operate so that they expect the input geometry to be defined with right-handed coordinates.

_Figure 2_ shows the spaces with requirements with more details. It can be observed that their basic structure is very similar and consistent: Each space is defined with a right-handed coordinate system where the x-axis points to the right, and the y-axis points down. Now, "right" and "down" might be terrible descriptions of the matter, but at least if we follow these thoughts through to the framebuffer space and imagine a framebuffer being rendered on a screen, they should hopefully get the point across. I.e. an image (in framebuffer space) is drawn to the screen s.t. its origin is assumed to be in the top-left corner, increasing x coordinates refer to pixels from left to right on the screen, and increasing y coordinates refer to pixels from top to bottom on the screen. The z-axis pointing "into" the screen shall indicate that depth values increase the further away an object is.

{: .center}
[![Clip Space, Normalized Device Coordinates, and Framebuffer Space in Vulkan](/assets/images/vulkan-spaces.png)](/assets/images/vulkan-spaces.png)

_Figure 2:_ The spaces which Vulkan works with and performs fixed-function operations in are all assumed to be given in a right-handed coordinate system with matching axes orientations. While clip space coordinates are given in homogeneous space, normalized device coordinates only contain primitives within the unit cube from $(-1, -1, 0)^T$ to $(1, 1, 0)^T$. Framebuffer space's x and y coordinates range from $ [0..w) $ and $[0..h)$, with $w$ referring to the framebuffer's horizontal resolution, and $h$ referring to the framebuffer's vertical resolution. 


$$ \begin{pmatrix}
\frac{2 n}{r - l} & 0 & \frac{r + l}{r - l} & 0 \\
0 & \frac{2 n}{t - b} & \frac{t + b}{t - b} & 0 \\
0 & 0 & -\frac{f + n}{f - n} & \frac{2 f n}{f - n} \\
0 & 0 & -1 & 0 
\end{pmatrix} $$      

_Equation 1:_ Typical OpenGL projection matrix as generated by good old [`glFrustum`](https://www.khronos.org/registry/OpenGL-Refpages/gl2.1/xhtml/glFrustum.xml) (or with better formatting here: [Scratchpixel 2.0 - The Perspective and Orthographic Projection Matrix](https://www.scratchapixel.com/lessons/3d-basic-rendering/perspective-and-orthographic-projection-matrix/opengl-perspective-projection-matrix). 

{: .center}
[![Clip Space and Normalized Device Coordinates details in OpenGL](/assets/images/clip_cube_ndc_cube_opengl.png)](/assets/images/clip_cube_ndc_cube_opengl.png)



{: .center}
[![Flipping the z-axis and flipping the y-axis](/assets/images/inv-z-then-y-fade.gif)](/assets/images/inv-z-then-y-fade.gif)

{: .center}
[![Rotating a right-handed coordinate system](/assets/images/inv-not-but-rot-fade.gif)](/assets/images/inv-not-but-rot-fade.gif)
